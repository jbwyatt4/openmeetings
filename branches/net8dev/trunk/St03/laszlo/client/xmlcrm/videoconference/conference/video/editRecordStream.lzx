<?xml version="1.0" encoding="UTF-8" ?>
<library>
    
<!-- #######################
	Class editRecordStream
	
	Description:
	This Class shows a window where you can alter you Video-/Microphone- Input-Resources
	and start to stream. The app could also use the default values for Cam/Mic but
	must users don't know how to alter this (wether in System-Control-Panel or by Right Clicking
	on the Flash-Screen and *>Preferences>Camera* )
	So I think it is better if Users are forced to choose something from this list
	
 -->
 
<class name="editRecordStream"  extends="labelExplorerBox" labelid="51"
	width="300" height="250" x="14" y="40" >

    <attribute name="myvideocontainer" value="null" />
    
    <attribute name="chosenCam" value="null" />
    <attribute name="chosenMic" value="null" />
    <attribute name="chosenSetting" value="null" />
    <attribute name="currentClient" value="null" />
    	
	<handler name="oninit">
		Debug.write("this.myvideocontainer ",this.myvideocontainer);			
		Debug.write("editrecordstream ###################### ");
        var t = new sharedObject();
        t.getLocal('userdata');
        var g = t.getData('userdata');
        var save = g["savecamdata"];
        //Debug.write("save: ",save,g["cam"],g["mic"]);
        if(save) {
        	this.chosenCam = g["cam"];
        	this.chosenMic = g["mic"];
        	this.chosenSetting = g["avstored"];
			this.remoteMessage = new Array();
			this.remoteMessage[0] = 'avsettings';
			this.remoteMessage[2] = this.chosenSetting;        	
        	this.getBroadCastId.doCall();		
        }
	</handler>
    
    <method name="storelocaldata">
        <![CDATA[
        if (this.holddatainSO.getValue()){
            //Debug.write("sharedobject store ");
            var t = new sharedObject();
            t.getLocal('userdata');
            var g = t.getData('userdata');
            if (g==null) g = new Array();
            g["cam"] = this.availibleCams.getValue();
            g["mic"] = this.availibleMics.getValue();
            g["avstored"] = this.availibleSettings.getValue();
            g["savecamdata"] = true;
            t.setData('userdata',g);
            t.flush();  
        } else {
            var t = new sharedObject();
            t.getLocal('userdata');
            var g = t.getData('userdata');
            if (g==null) g = new Array();
            g["cam"] = this.availibleCams.getValue();
            g["mic"] = this.availibleMics.getValue();
            g["avstored"] = this.availibleSettings.getValue();
            g["savecamdata"]=false;
            t.setData('userdata',g);
            t.flush(); 
        }        
        ]]>
    </method>   	
    
    <netRemoteCallHib name="getBroadCastId" funcname="getBroadCastId" 
    				  remotecontext="$once{ canvas.thishib }" >  
    	<handler name="ondata" args="value">
        	<![CDATA[
        		Debug.write("getBroadCastId",value);
        		parent.myvideocontainer = canvas._videocontainer.getNewVideoObject(value);
        		parent.setUserAVSettings.doCall();
            ]]>
        </handler>   
    </netRemoteCallHib>  
    
    <netRemoteCallHib name="setUserAVSettings" funcname="setUserAVSettings" 
    				  remotecontext="$once{ canvas.thishib }" >  
    	<netparam><method name="getValue">return parent.parent.chosenSetting;</method></netparam>
    	<netparam><method name="getValue">return parent.parent.remoteMessage;</method></netparam>
        <handler name="ondata" args="value">
        	<![CDATA[
        		Debug.write("setUserAVSettings",value);
        		
        		parent.currentClient = value;
            	parent.doninitalize();
            ]]>
        </handler>   
    </netRemoteCallHib>    

    <method name="doninitalize">
    	<![CDATA[
    		var valCam = this.chosenCam;
			var valMic = this.chosenMic;
			var settings = this.chosenSetting;
	    	Debug.write("this.myvideocontainer: ",this.myvideocontainer);
	    	Debug.write(valCam,valMic,settings);
	        this.myvideocontainer.cameraRef.setAttribute('deviceindex',valCam);
	        this.myvideocontainer.microphoneRef.setAttribute('deviceindex',valMic);
	
			this.myvideocontainer.parent.parent.setAttribute('isremote',false);
	        
	        this.myvideocontainer.parent.parent.setIdentifier(canvas.streamid);
			
			//camera.setMode(width, height, fps[, favorsize])
			this.myvideocontainer.cameraRef.setMode(this.myvideocontainer.width,this.myvideocontainer.height,30);
			//camera.setQuality(bandwidth, picturequality)
			Debug.write("this.myvideocontainer.cameraRef.bandwidth: ",this.myvideocontainer.cameraRef.bandwidth);
			this.myvideocontainer.cameraRef.setQuality(this.myvideocontainer.cameraRef.bandwidth,0.9);
			//Microphone.set
			if (canvas.vaquality=="best") {
				this.myvideocontainer.microphoneRef.setRate(44);
			} else {
				this.myvideocontainer.microphoneRef.setRate(22);
			}
			
			//Microphone setUseEchoSupression(bool)
		    this.myvideocontainer.microphoneRef.setUseEchoSupression(true);
			this.myvideocontainer.v_output.setBufferTime(0);
	    	switch (settings){
	    		case "av":
	    			this.myvideocontainer.cameraRef.setAttribute('show',true);
	    			this.myvideocontainer.microphoneRef.setAttribute('capturing',true);
	    			this.myvideocontainer.v_output.broadcast(this.currentClient.broadCastID,this.myvideocontainer.cameraRef,this.myvideocontainer.microphoneRef);
	    			break;
	    		case "a":
	    			this.myvideocontainer.microphoneRef.setAttribute('capturing',true);
	    			this.myvideocontainer.v_output.broadcast(this.currentClient.broadCastID,null,this.myvideocontainer.microphoneRef);
	    			break;	 
	    		case "v":
	    			this.myvideocontainer.cameraRef.setAttribute('show',true);
	    			this.myvideocontainer.v_output.broadcast(this.currentClient.broadCastID,this.myvideocontainer.cameraRef,null);
	    			break;	
	    		case "n":
	    			Debug.write("Do not Publish A/V");
	    			break;
	    		default:
	    			Debug.warn("no valid device Setup chosen");
	    			break;
	    	}

	        this.myvideocontainer.parent.parent.setAttribute('chatpartnername',canvas.firstName+' '+canvas.lastName);
	        
	        this.close();
        ]]>
    </method>    

    <labelText labelid="447" fontsize="12" x="10" y="20" />
    
    <combobox fontsize="12" name="availibleSettings" x="10" y="40" width="280" editable="false">
        <handler name="oninit">
            <![CDATA[
				this.addItem(canvas.getLabelName(448),"av");
				this.addItem(canvas.getLabelName(449),"a");
				this.addItem(canvas.getLabelName(450),"v");
				this.addItem(canvas.getLabelName(451),"n");
            
				var r = "av";

				var t = new sharedObject();
				t.getLocal('userdata');
				var g = t.getData('userdata');
				if (g!=null){
					var cam = g["avstored"];
				} else {
					var cam = r;
				}
				if (cam=='undefined' || cam =='' || cam == null) cam=r;
				this.selectItem(String(cam));    

            ]]>
        </handler>
        <handler name="onselect">
        	<![CDATA[
        		var camVisible = "visible";
        		var micVisible = "visible";
        		var textVisible = "hidden";
	        	switch (this.getValue()){
	        		case "av":
	        			break;
	        		case "a":
	        			camVisible = "hidden";
	        			break;	 
	        		case "v":
	        			micVisible = "hidden";
	        			break;	
	        		case "n":
	        			camVisible = "hidden";
	        			micVisible = "hidden";
	        			textVisible = "visible";
	        			break;
	        		default:
	        			Debug.warn("no valid device Setup chosen");
	        			break;
	        	}
    			this.parent.availibleCamsLabel.setAttribute("visibility",camVisible);
    			this.parent.availibleCams.setAttribute("visibility",camVisible);
    			this.parent.availibleMicsLabel.setAttribute("visibility",micVisible);
    			this.parent.availibleMics.setAttribute("visibility",micVisible);	   
    			this.parent.infoTextNoAV.setAttribute("visibility",textVisible);
        	]]>
        </handler>
    </combobox>    
     
    <labelText name="availibleCamsLabel" labelid="52" fontsize="12" x="10" y="80" />

    <combobox fontsize="12" name="availibleCams" x="10" y="100" width="280" editable="false">
        <handler name="oninit">
            <![CDATA[
				//Get all availible Cam's
				var tw = Camera.names;
				var r = "";
				for (var eg=0;eg<tw.length;eg++){
					this.addItem(tw[eg],eg);
					r=eg;
				}
				var t = new sharedObject();
				t.getLocal('userdata');
				var g = t.getData('userdata');
				if (g!=null){
					var cam = g["cam"];
				} else {
					var cam = r;
				}
				if (cam=='undefined' || cam =='' || cam == null) cam=r;
				this.selectItem(String(cam));    

            ]]>
        </handler>
    </combobox>
    
    <labelText name="availibleMicsLabel" labelid="53" fontsize="12" x="10" y="120" />

    <combobox fontsize="12" name="availibleMics"  x="10" y="140" width="280" editable="false">
        <handler name="oninit">
            <![CDATA[
	            //Get all availible Mic's
	            var tw = Microphone.names;
	            var r = "";
	            for (var eg=0;eg<tw.length;eg++){
	                r=eg;
	                this.addItem(tw[eg],eg);
	            }
	            
	            var t = new sharedObject();
	            t.getLocal('userdata');
	            var g = t.getData('userdata');
	            if (g!=null){
	            	var mic = g["mic"];
	            } else {
	            	var mic = r;
	            }
				if (mic=='undefined' || mic =='' || mic ==null) mic=r;
				this.selectItem(String(mic));  
            ]]>
        </handler>
    </combobox>
    
    <labelText name="infoTextNoAV" labelid="452" multiline="true" width="280" 
    		   fontsize="12" x="10" y="80" visibility="hidden" />
    
    <!-- Remember Me -->    
    <checkbox name="holddatainSO" text="Do not ask again" x="10" y="210">
        <handler name="oninit">
            var t = new sharedObject();
            t.getLocal('userdata');
            var g = t.getData('userdata');
            var save = g["savecamdata"];
            Debug.write("savecamdata save: ",save);
            if(save) this.setValue(true);
        </handler>         
    </checkbox>
    
    <simpleLabelButton fontsize="12" labelid="54" x="190" y="180" width="100">
        <handler name="onclick">
        	this.parent.storelocaldata();
        	this.parent.chosenCam = parent.availibleCams.getValue();
        	this.parent.chosenMic = parent.availibleMics.getValue();
        	this.parent.chosenSetting = parent.availibleSettings.getValue();      
			this.parent.remoteMessage = new Array();
			this.parent.remoteMessage[0] = 'avsettings';
			this.parent.remoteMessage[1] = "0";
			this.parent.remoteMessage[2] = this.parent.chosenSetting;              	
            this.parent.getBroadCastId.doCall();
        </handler>
    </simpleLabelButton>

</class>
    
</library>
